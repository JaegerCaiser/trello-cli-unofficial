name: Debug NPM Connection

on: [push, workflow_dispatch]

permissions:
  id-token: write
  contents: read

jobs:
  investigate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org'

      - name: üîç CSI - Investiga√ß√£o Profunda
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            // CORRE√á√ÉO: Mudamos o nome da vari√°vel para execSync para n√£o conflitar
            const execSync = require('child_process').execSync;

            console.log('--- 1. Gerando Token OIDC Fresco ---');
            const token = await core.getIDToken('https://registry.npmjs.org');
            console.log(`Token gerado com sucesso! (In√≠cio: ${token.substring(0, 15)}...)`);

            console.log('\n--- 2. Conte√∫do do .npmrc ---');
            try {
              const homeNpmrc = path.resolve(process.env.HOME, '.npmrc');

              if (fs.existsSync(homeNpmrc)) {
                 console.log(`[HOME] .npmrc encontrado em: ${homeNpmrc}`);
                 const content = fs.readFileSync(homeNpmrc, 'utf8');
                 // Mascarando o token para n√£o vazar no log se for o real
                 console.log(content.replace(/_authToken=.*\b/, '_authToken=[MASCARADO]'));
              } else {
                 console.log('‚ùå NENHUM .npmrc ENCONTRADO NA HOME!');
              }
            } catch (e) {
              console.log('Erro ao ler .npmrc:', e);
            }

            console.log('\n--- 3. Teste Direto via CURL (A Hora da Verdade) ---');
            try {
              // Usamos o token gerado agora para tentar autenticar na marra
              const cmd = `curl -s -v -H "Authorization: Bearer ${token}" https://registry.npmjs.org/-/whoami`;

              console.log('Executando curl contra registry.npmjs.org...');
              const output = execSync(cmd, { encoding: 'utf8', stdio: 'pipe' });
              console.log('\n‚úÖ SUCESSO ABSOLUTO! Resposta do NPM:');
              console.log(output);
            } catch (error) {
              console.log('\n‚ùå FALHA NO CURL (Erro 401 Confirmado):');
              console.log('Message:', error.message);
              // Imprime o output do erro para vermos o status code exato
              if (error.stdout) console.log('STDOUT:', error.stdout.toString());
              if (error.stderr) console.log('STDERR:', error.stderr.toString());
            }
