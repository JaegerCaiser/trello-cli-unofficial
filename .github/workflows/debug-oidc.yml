name: Debug OIDC Token

on:
  push:
    branches: [main]
  workflow_dispatch: # Permite rodar manualmente pelo botão no GitHub

permissions:
  id-token: write
  contents: read

jobs:
  debug-claims:
    runs-on: ubuntu-latest
    steps:
      - name: Install OIDC Client
        run: npm install @actions/core @actions/http-client

      - name: Debug OIDC Claims
        uses: actions/github-script@v7
        with:
          script: |
            const core = require('@actions/core');
            try {
              // 1. Pede o token para o provedor do GitHub
              const token = await core.getIDToken('https://registry.npmjs.org');
              
              // 2. Decodifica o payload do JWT (Parte do meio do token)
              const payload = token.split('.')[1];
              const decoded = Buffer.from(payload, 'base64').toString('utf-8');
              const claims = JSON.parse(decoded);
              
              console.log("--- INÍCIO DO PAYLOAD OIDC ---");
              console.log(JSON.stringify(claims, null, 2));
              console.log("--- FIM DO PAYLOAD OIDC ---");
              
              // Verificações visuais importantes
              console.log("\n--- VERIFICAÇÃO CRÍTICA ---");
              console.log(`Repository Claim: ${claims.repository}`);
              console.log(`Workflow Ref:     ${claims.job_workflow_ref}`);
              console.log(`Actor (User):     ${claims.actor}`);
              console.log("---------------------------");
              
            } catch (err) {
              core.setFailed(`Falha ao pegar token: ${err}`);
            }