name: Debug OIDC Token

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  debug-claims:
    runs-on: ubuntu-latest
    steps:
      - name: Debug OIDC Claims
        uses: actions/github-script@v7
        with:
          script: |
            try {
              // O 'core' já existe no contexto global desta action
              const token = await core.getIDToken('https://registry.npmjs.org');
              
              const payload = token.split('.')[1];
              const decoded = Buffer.from(payload, 'base64').toString('utf-8');
              const claims = JSON.parse(decoded);
              
              console.log("--- INÍCIO DO PAYLOAD OIDC ---");
              console.log(JSON.stringify(claims, null, 2));
              console.log("--- FIM DO PAYLOAD OIDC ---");
              
              console.log("\n--- VERIFICAÇÃO CRÍTICA (Compare com o site do NPM) ---");
              console.log(`Repository Claim: ${claims.repository}`);
              console.log(`Workflow Ref:     ${claims.job_workflow_ref}`);
              console.log(`Actor (User):     ${claims.actor}`);
              console.log("---------------------------");
              
            } catch (err) {
              core.setFailed(`Falha ao pegar token: ${err}`);
            }